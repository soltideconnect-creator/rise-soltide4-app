# üö® URGENT: Google Play Billing TWA Wrapper Fix Guide

## ‚ö†Ô∏è Critical Issue

**Current Bug**: Tapping "Get Premium $4.99" opens external Play Store instead of showing in-app billing overlay.

**Expected Behavior**: In-app billing overlay should pop up inside the TWA app using `BillingClient.launchBillingFlow()`.

**Impact**: Breaks the $4.99 premium purchase flow, preventing users from buying premium features.

---

## üéØ Root Cause

The TWA (Trusted Web Activity) wrapper's native Android code is incorrectly configured. Instead of launching the billing flow inside the app, it's opening an external Play Store intent.

**This issue MUST be fixed in the native Android TWA wrapper project**, not in the web code.

---

## ‚úÖ Web-Side Fix (COMPLETED)

The web-side code has been updated with:
- ‚úÖ 5-second timeout fallback
- ‚úÖ Improved error messages
- ‚úÖ Better logging for debugging
- ‚úÖ Contact information for support

**File Updated**: `src/utils/googlePlayBilling.ts`

---

## üîß Native Android TWA Wrapper Fix (REQUIRED)

### **Location**: TWA Android Project (separate from this web project)

The TWA wrapper is typically generated by:
- PWABuilder (https://www.pwabuilder.com/)
- Bubblewrap (https://github.com/GoogleChromeLabs/bubblewrap)
- Custom Android Studio project

---

## üìù Step-by-Step Fix Instructions

### **Step 1: Locate Your TWA Android Project**

The TWA wrapper is a separate Android project, typically located at:
```
/path/to/your-twa-project/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ       ‚îî‚îÄ‚îÄ main/
‚îÇ           ‚îî‚îÄ‚îÄ java/
‚îÇ               ‚îî‚îÄ‚îÄ com/
‚îÇ                   ‚îî‚îÄ‚îÄ yourapp/
‚îÇ                       ‚îú‚îÄ‚îÄ MainActivity.java
‚îÇ                       ‚îî‚îÄ‚îÄ BillingBridge.java (or similar)
‚îú‚îÄ‚îÄ build.gradle
‚îî‚îÄ‚îÄ AndroidManifest.xml
```

---

### **Step 2: Fix the AndroidBilling.buy() Implementation**

#### **Option A: If using PWABuilder-generated TWA**

1. Open your TWA project in Android Studio
2. Locate the billing bridge file (usually `BillingBridge.java` or similar)
3. Find the `buy()` method
4. Replace the current implementation with:

```java
// BillingBridge.java or similar file

@JavascriptInterface
public void buy(String productId) {
    Log.d("BillingBridge", "buy() called with productId: " + productId);
    
    // Query SKU details first
    List<String> skuList = new ArrayList<>();
    skuList.add(productId);
    
    SkuDetailsParams.Builder params = SkuDetailsParams.newBuilder();
    params.setSkusList(skuList).setType(BillingClient.SkuType.INAPP);
    
    billingClient.querySkuDetailsAsync(params.build(), new SkuDetailsResponseListener() {
        @Override
        public void onSkuDetailsResponse(BillingResult billingResult, List<SkuDetails> skuDetailsList) {
            if (billingResult.getResponseCode() == BillingClient.BillingResponseCode.OK && skuDetailsList != null) {
                for (SkuDetails skuDetails : skuDetailsList) {
                    if (skuDetails.getSku().equals(productId)) {
                        // Launch billing flow IN-APP (not external)
                        BillingFlowParams billingFlowParams = BillingFlowParams.newBuilder()
                            .setSkuDetails(skuDetails)
                            .build();
                        
                        // CRITICAL: Launch in current activity (in-app overlay)
                        BillingResult result = billingClient.launchBillingFlow(activity, billingFlowParams);
                        
                        if (result.getResponseCode() != BillingClient.BillingResponseCode.OK) {
                            Log.e("BillingBridge", "Failed to launch billing flow: " + result.getDebugMessage());
                            notifyWebViewError("Failed to launch billing flow");
                        } else {
                            Log.d("BillingBridge", "Billing flow launched successfully");
                        }
                        return;
                    }
                }
            } else {
                Log.e("BillingBridge", "Failed to query SKU details: " + billingResult.getDebugMessage());
                notifyWebViewError("Failed to query product details");
            }
        }
    });
}
```

#### **Option B: If using Bubblewrap-generated TWA**

1. Open `app/src/main/java/com/yourapp/BillingManager.java`
2. Locate the `launchBillingFlow()` method
3. Ensure it's NOT using external intents:

```java
// WRONG - Opens external Play Store
Intent intent = new Intent(Intent.ACTION_VIEW);
intent.setData(Uri.parse("https://play.google.com/store/apps/details?id=..."));
startActivity(intent);

// CORRECT - Opens in-app billing overlay
BillingFlowParams billingFlowParams = BillingFlowParams.newBuilder()
    .setSkuDetails(skuDetails)
    .build();
billingClient.launchBillingFlow(activity, billingFlowParams);
```

---

### **Step 3: Verify BillingClient Initialization**

Ensure `BillingClient` is properly initialized in your `MainActivity.java`:

```java
// MainActivity.java

private BillingClient billingClient;

@Override
protected void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    
    // Initialize BillingClient
    billingClient = BillingClient.newBuilder(this)
        .setListener(purchasesUpdatedListener)
        .enablePendingPurchases()
        .build();
    
    // Start connection
    billingClient.startConnection(new BillingClientStateListener() {
        @Override
        public void onBillingSetupFinished(BillingResult billingResult) {
            if (billingResult.getResponseCode() == BillingClient.BillingResponseCode.OK) {
                Log.d("MainActivity", "Billing client connected");
                // Billing client is ready
            } else {
                Log.e("MainActivity", "Billing setup failed: " + billingResult.getDebugMessage());
            }
        }
        
        @Override
        public void onBillingServiceDisconnected() {
            Log.w("MainActivity", "Billing service disconnected");
            // Try to restart connection
        }
    });
}
```

---

### **Step 4: Add Required Dependencies**

Ensure your `app/build.gradle` includes the Google Play Billing library:

```gradle
dependencies {
    // Google Play Billing Library (latest version)
    implementation 'com.android.billingclient:billing:6.0.1'
    
    // Other dependencies...
}
```

---

### **Step 5: Update AndroidManifest.xml**

Ensure billing permission is declared:

```xml
<!-- AndroidManifest.xml -->
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.yourapp">
    
    <!-- Billing permission -->
    <uses-permission android:name="com.android.vending.BILLING" />
    
    <application
        android:name=".Application"
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:theme="@style/AppTheme">
        
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:launchMode="singleTask">
            <!-- Activity configuration -->
        </activity>
    </application>
</manifest>
```

---

### **Step 6: Implement Purchase Callback**

Add purchase update listener to handle successful purchases:

```java
// MainActivity.java or BillingBridge.java

private PurchasesUpdatedListener purchasesUpdatedListener = new PurchasesUpdatedListener() {
    @Override
    public void onPurchasesUpdated(BillingResult billingResult, List<Purchase> purchases) {
        if (billingResult.getResponseCode() == BillingClient.BillingResponseCode.OK && purchases != null) {
            for (Purchase purchase : purchases) {
                handlePurchase(purchase);
            }
        } else if (billingResult.getResponseCode() == BillingClient.BillingResponseCode.USER_CANCELED) {
            Log.d("Billing", "User cancelled purchase");
            notifyWebView("purchase_cancelled");
        } else {
            Log.e("Billing", "Purchase failed: " + billingResult.getDebugMessage());
            notifyWebView("purchase_failed");
        }
    }
};

private void handlePurchase(Purchase purchase) {
    if (purchase.getPurchaseState() == Purchase.PurchaseState.PURCHASED) {
        // Verify purchase on your server (optional but recommended)
        
        // Acknowledge purchase
        if (!purchase.isAcknowledged()) {
            AcknowledgePurchaseParams acknowledgePurchaseParams =
                AcknowledgePurchaseParams.newBuilder()
                    .setPurchaseToken(purchase.getPurchaseToken())
                    .build();
            
            billingClient.acknowledgePurchase(acknowledgePurchaseParams, new AcknowledgePurchaseResponseListener() {
                @Override
                public void onAcknowledgePurchaseResponse(BillingResult billingResult) {
                    if (billingResult.getResponseCode() == BillingClient.BillingResponseCode.OK) {
                        Log.d("Billing", "Purchase acknowledged");
                        notifyWebView("purchase_success");
                    }
                }
            });
        } else {
            notifyWebView("purchase_success");
        }
    }
}

private void notifyWebView(String status) {
    // Notify web view of purchase status
    runOnUiThread(() -> {
        webView.evaluateJavascript(
            "window.dispatchEvent(new CustomEvent('billing_status', { detail: '" + status + "' }));",
            null
        );
    });
}
```

---

## üß™ Testing Instructions

### **Step 1: Build and Install**

```bash
# In your TWA Android project directory
./gradlew assembleDebug

# Install on device
adb install app/build/outputs/apk/debug/app-debug.apk
```

### **Step 2: Test Billing Flow**

1. Open the app on a physical Android device (emulators don't support real billing)
2. Navigate to Stats page
3. Tap "Get Premium - $4.99 (Google Play)"
4. **Expected**: In-app billing overlay appears within 1-2 seconds
5. **Not Expected**: External Play Store opens

### **Step 3: Verify Logs**

```bash
# Monitor logs while testing
adb logcat | grep -E "(Billing|AndroidBilling)"
```

**Expected logs**:
```
D/BillingBridge: buy() called with productId: premium_unlock
D/BillingBridge: Billing flow launched successfully
D/Billing: Purchase acknowledged
```

**Problem logs** (if still broken):
```
E/BillingBridge: Failed to launch billing flow
E/Billing: Purchase failed
```

---

## üöÄ Deployment Steps

### **Step 1: Build Release AAB**

```bash
# In your TWA Android project
./gradlew bundleRelease

# Output: app/build/outputs/bundle/release/app-release.aab
```

### **Step 2: Update Version**

Update `app/build.gradle`:
```gradle
android {
    defaultConfig {
        versionCode 6  // Increment from current version
        versionName "1.0.0.6"
    }
}
```

### **Step 3: Upload to Google Play Console**

1. Go to Google Play Console
2. Navigate to your app ‚Üí Release ‚Üí Closed Testing
3. Create new release
4. Upload `app-release.aab`
5. Add release notes: "Fix billing flow to in-app overlay ‚Äî no external Play Store intent"
6. Review and rollout

### **Step 4: Test in Closed Testing**

1. Install from closed testing track
2. Test premium purchase flow
3. Verify in-app overlay appears
4. Verify purchase completes successfully
5. Test "Restore Purchase" button

---

## üìä Verification Checklist

- [ ] TWA Android project located
- [ ] `BillingClient.launchBillingFlow()` implemented correctly
- [ ] No external Play Store intents in code
- [ ] BillingClient properly initialized
- [ ] Dependencies updated (billing:6.0.1)
- [ ] AndroidManifest.xml has billing permission
- [ ] Purchase callback implemented
- [ ] Debug build tested on device
- [ ] In-app overlay appears (not external Play Store)
- [ ] Purchase completes successfully
- [ ] Restore purchase works
- [ ] Release AAB built with new version
- [ ] Uploaded to closed testing
- [ ] Tested in closed testing environment

---

## üêõ Common Issues & Solutions

### **Issue 1: "BillingClient not initialized"**
**Solution**: Ensure `billingClient.startConnection()` is called in `onCreate()` before any billing operations.

### **Issue 2: "SKU not found"**
**Solution**: Verify product ID "premium_unlock" is configured in Google Play Console ‚Üí Monetization ‚Üí In-app products.

### **Issue 3: "External Play Store still opens"**
**Solution**: Search your code for `Intent.ACTION_VIEW` and remove any Play Store URL intents. Use only `launchBillingFlow()`.

### **Issue 4: "Billing overlay appears but closes immediately"**
**Solution**: Check `purchasesUpdatedListener` is properly implemented and not throwing exceptions.

### **Issue 5: "Purchase succeeds but web doesn't update"**
**Solution**: Ensure `notifyWebView()` is called after successful purchase to update the web-side state.

---

## üìû Support

If you encounter issues during implementation:

1. **Check logs**: `adb logcat | grep Billing`
2. **Verify product ID**: Must match "premium_unlock" in Play Console
3. **Test on real device**: Emulators don't support real billing
4. **Contact support**: soltidewellness@gmail.com

---

## üéØ Expected Outcome

After implementing these fixes:

‚úÖ **User taps "Get Premium $4.99"**  
‚úÖ **In-app billing overlay appears within 1-2 seconds**  
‚úÖ **User completes purchase in-app**  
‚úÖ **Premium features unlock immediately**  
‚úÖ **No external Play Store navigation**  
‚úÖ **Restore Purchase works correctly**  

---

## üìù Commit Message

```
Fix billing flow to in-app overlay ‚Äî no external Play Store intent

- Implement BillingClient.launchBillingFlow() in TWA wrapper
- Remove external Play Store intent navigation
- Add 5-second timeout fallback in web code
- Improve error messages with support contact
- Update billing flow to show in-app overlay only

Fixes: Premium purchase flow opening external Play Store
Version: 1.0.0.6
Testing: Verified in closed testing track
```

---

## ‚è∞ Timeline

**Estimated Time**: 2-4 hours

1. **Locate TWA project**: 15 minutes
2. **Implement billing fix**: 1-2 hours
3. **Test on device**: 30 minutes
4. **Build release AAB**: 15 minutes
5. **Upload to Play Console**: 15 minutes
6. **Test in closed testing**: 30 minutes

**Total**: 2-4 hours depending on familiarity with Android development

---

## üéâ Success Criteria

- [x] Web-side timeout fallback added ‚úÖ
- [ ] Native Android billing flow fixed
- [ ] In-app overlay appears (not external Play Store)
- [ ] Purchase completes successfully
- [ ] Restore purchase works
- [ ] New AAB uploaded to closed testing
- [ ] Tested and verified in closed testing

---

**Status**: Web-side fix COMPLETE ‚úÖ | Native Android fix REQUIRED ‚è≥  
**Priority**: URGENT üö®  
**Blocker**: Production billing compliance  
**Next Step**: Implement native Android fixes in TWA wrapper project

---

**Generated**: 2025-11-23  
**Version**: v502  
**Web Fix**: ‚úÖ COMPLETE  
**Native Fix**: ‚è≥ PENDING (requires TWA project access)
